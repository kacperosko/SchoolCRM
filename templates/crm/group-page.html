{% extends 'base/base.html' %}
{% load static %}
{% block title %}{{ record.get_full_name }}{% endblock title %}
{% block style %}
    <style>
        .attendance_list:hover {
            opacity: 0.7;
            transition: opacity;
            transition-delay: 100ms;
        }
    </style>
{% endblock style %}
{% block content %}
    {% load crm_tags %}

    <div class="card">

        <div class="card-header d-flex justify-content-between">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/group"><i
                            class="ri-home-4-line mr-1 float-left"></i>Grupy</a></li>
                    <li class="breadcrumb-item active"
                        aria-current="page">{{ record.get_full_name }}</li>
                </ol>
            </nav>
            <div>
                <button id="watch-button" class="btn rounded-pill" data-trigger="hover" data-toggle="popover"
                        data-content="{% if watch_record %}Obserwujesz ten rekord{% else %}Chcesz obserwować ten rekord?{% endif %}"
                        data-placement="bottom"
                        onclick="watchRecord('{{ record.id }}')"
                        watching-record="{% if watch_record %}following{% else %}notFollowing{% endif %}">
                    <svg id="watch_icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke-width="{% if watch_record %}2.5{% else %}1.5{% endif %}"
                         stroke="currentColor" class="w-6 h-6 {% if watch_record %}text-primary{% endif %}" width="25">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path>
                    </svg>
                </button>
                {% if perms.crm.change_group %}
                    <a href="/group/edit/{{ record.id }}"
                       class="btn btn-primary rounded-pill font-size-12 align-content-center d-inline-flex">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1"
                             stroke="currentColor" class="w-6 h-6 mr-1" width="18">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                        Edytuj
                    </a>
                {% endif %}
                {% if perms.crm.delete_group %}
                    <a href="/delete/{{ record.id }}"
                       class="btn btn-outline-danger rounded-pill font-size-12 d-inline-flex align-content-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                             stroke="currentColor" class="w-6 h-6 mr-1" width="18">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"></path>
                        </svg>
                        Usuń
                    </a>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="myTab-1" role="tablist">
                <li class="nav-item">
                    <a class="nav-link {% if request.GET.tab == 'Details' %}active{% endif %}" id="home-tab"
                       data-toggle="tab" href="#details" role="tab"
                       aria-controls="details" aria-selected="true"
                       onclick="addParamToURL('tab', 'Details')">Szczegóły</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.GET.tab == 'Lessons' %}active{% endif %}" id="lessons-tab"
                       data-toggle="tab" href="#lessons" role="tab"
                       aria-controls="lessons" aria-selected="false"
                       onclick="addParamToURL('tab', 'Lessons'), generate_lessons()">Lekcje</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.GET.tab == 'Attendance' %}active{% endif %}" id="lessons-tab"
                       data-toggle="tab" href="#attendance" role="tab"
                       aria-controls="lessons" aria-selected="false"
                       onclick="addParamToURL('tab', 'Attendance')">Listy Obecności</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.GET.tab == 'Notes' %}active{% endif %}" id="lessons-tab"
                       data-toggle="tab" href="#notes" role="tab"
                       aria-controls="lessons" aria-selected="false"
                       onclick="addParamToURL('tab', 'Notes')">Notatki</a>
                </li>

            </ul>
            <div class="tab-content" id="tab-student">
                <div class="tab-pane fade {% if request.GET.tab == 'Details' %}show active{% endif %}" id="details"
                     role="tabpanel" aria-labelledby="details-tab">


                    <div class=" row align-items-center">
                        <div class="form-group col-sm-6">
                            <label class="text-muted">Nazwa:</label>
                            <p class="pb-1 field">{{ record.name }}</p>
                        </div>
                        <div class="form-group col-sm-6"></div>

                        <div class="form-group col-sm-6">
                            <label class="text-muted">Utworzono:</label>
                            <p class="pb-1 field">{{ record.created_date|default:"-" }}
                                {% if record.created_by %}
                                    <a href="/user/{{ record.created_by.id }}">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"
                                             class="ml-1" width="18px">
                                            <path d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                                                  stroke-linecap="round" stroke-linejoin="round"></path>
                                        </svg>
                                        <span class="my-auto">{{ record.created_by.get_full_name|default:"-" }}</span>
                                    </a>
                                {% else %}
                                    <span class="my-auto">Użytkownik usunięty</span>
                                {% endif %}
                            </p>

                        </div>

                        <div class="form-group col-sm-6">
                            <label class="text-muted">Ostatnio zmodyfikowano:</label>
                            <p class="pb-1 field">{{ record.modified_date|default:"-" }}
                                {% if record.modified_by %}
                                    <a href="/user/{{ record.modified_by.id }}">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"
                                             class="ml-1" width="18px">
                                            <path d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                                                  stroke-linecap="round" stroke-linejoin="round"></path>
                                        </svg>
                                        <span class="my-auto">{{ record.modified_by.get_full_name|default:"-" }}</span>
                                    </a>
                                {% else %}
                                    <span class="my-auto">Użytkownik usunięty</span>
                                {% endif %}
                            </p>

                        </div>
                    </div>
                    <div class="mb-5"></div>
                    <div class="table-responsive">
                        <div class="d-flex justify-content-between mb-2">
                            <h5 class="card-title">Studenci w grupie:</h5>
                            {% if perms.crm.add_groupstudent %}
                                <a href="/Groupstudent/new?group={{ record.id }}&discard_url=/group/{{ record.id }}"
                                   class="btn btn-primary rounded-pill font-size-12">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                         stroke-width="1.5"
                                         stroke="currentColor" class="w-6 h-6" width="18">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                              d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 1-4.512-.645-6.374-1.766Z"></path>
                                    </svg>
                                    Dodaj studenta do grupy
                                </a>
                            {% endif %}
                        </div>
                        <table class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <th scope="col" class="text-center">Imię Nazwisko</th>
                                <th scope="col" class="text-center">Email</th>
                                <th scope="col" class="text-center">Telefon</th>
                                <th scope="col" class="text-center"></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% if group_students %}
                                {% for group_student in group_students %}
                                    <tr>
                                        <th scope="row" class="text-center"
                                            onclick="toggleDetails(this)">
                                            <a type="button" href="/student/{{ group_student.student.id }}"
                                               class="">{{ group_student.student.get_full_name }}
                                            </a>
                                        </th>
                                        <td class="text-center">{{ group_student.student.email|default:"-" }}</td>
                                        <td class="text-center">{{ group_student.student.phone|default:"-" }}</td>
                                        <td class="text-center">
                                            <a class="text-warning"
                                               href="/delete/{{ group_student.id }}"
                                               data-trigger="hover" data-toggle="popover"
                                               data-content="Usuń relacje" data-placement="bottom">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                     stroke-width="1.5"
                                                     stroke="currentColor" class="w-6 h-6 mr-1" width="18">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                          d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"></path>
                                                </svg>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <td class="text-center" colspan="5">Brak studentów w grupie</td>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade {% if request.GET.tab == 'Lessons' %}show active{% endif %}" id="lessons"
                     role="tabpanel" aria-labelledby="lessons-tab">
                    <div class="d-flex justify-content-between">

                        <div class="d-flex align-items-center">
                            <button type="button"
                                    class="btn btn-outline-primary rounded-pill  d-flex align-content-center font-size-12"
                                    id="prevYearBtn"
                                    onclick="setQueryYear(-1)">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                     stroke-width="1.5"
                                     stroke="currentColor" class="w-6 h-6" width="18">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                          d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path>
                                </svg>
                            </button>
                            <button type="button"
                                    class="btn btn-outline-primary rounded-pill mx-1 d-flex align-content-center font-size-12"
                                    id="currentYearBtn"
                                    onclick="setQueryYearNow()">
                                Teraz
                            </button>

                            <button type="button"
                                    class="btn btn-outline-primary rounded-pill  d-flex align-content-center font-size-12"
                                    id="nextYearBTn"
                                    onclick="setQueryYear(1)">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                     stroke-width="1.5"
                                     stroke="currentColor" class="w-6 h-6" width="18">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                          d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3"></path>
                                </svg>

                            </button>
                        </div>
                        <div class="mx-2 font-weight-500 d-flex align-items-center">
                            <h5 id="selected-year">{{ request.GET.selected_year }}</h5>
                        </div>
                        <div class="d-flex">
                            <button type="button"
                                    class="btn btn-outline-primary rounded-pill mt-2 mb-3 mr-2 d-flex align-content-center font-size-12"
                                    onclick="window.location.href = '/group/{{ record.id }}/lesson-series'">
                                Zobacz serie lekcji
                            </button>

                            <button type="button"
                                    class="btn btn-primary rounded-pill mt-2 mb-3 d-flex align-content-center font-size-12"
                                    id="addLessonBtn" data-toggle="modal"
                                    data-target="#createEventModalCenter">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                     stroke-width="1.5"
                                     stroke="currentColor" class="w-6 h-6 mr-1" width="18">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                          d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z"></path>
                                </svg>
                                Utwórz lekcje
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive" id="table-container">
                        {# content auto generated by js after tab loaded by user #}
                        <div class="d-flex mx-auto justify-content-center">
                            <img src="{% static '/images/loader.gif' %}" alt="loader">
                        </div>
                    </div>
                </div>


                <div class="tab-pane fade {% if request.GET.tab == 'Attendance' %}show active{% endif %}"
                     id="attendance"
                     role="tabpanel" aria-labelledby="details-tab">

                    <div class="d-flex justify-content-end">
                        {% if request.user.is_admin %}
                            <a href="/attendanceList/new?group={{ record.id }}&discard_url=/group/{{ record.id }}?tab=Attendance"
                               class="btn btn-primary rounded-pill font-size-12 align-content-center d-inline-flex">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                     stroke="currentColor" width="18" class="mr-1">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path>
                                </svg>
                                Dodaj nową listę obecności
                            </a>
                        {% endif %}
                    </div>

                    <div class="p-2 align-items-center">
                        <h6 class="mb-2">Dzisiejsza lista:</h6>
                        <div class="container ml-0">
                            <div class="row">
                                {% if not today_attendance_list %}
                                   <div class="col-12 col-sm-6 col-md-4 col-lg-4">
                                        <div class="bg-light-light card-block p-3 rounded-lg">
                                            Brak dzisiejszej listy
                                            <button data-toggle="modal" data-target="#attendanceListCreateModalCenter" href=""
                                                    class="btn btn-primary py-1 px-2 rounded-pill align-content-center d-inline-flex mt-1">
                                                + Wygeneruj listę
                                            </button>
                                        </div>
                                   </div>
                                {% else %}
                                    <div class="col-12 col-sm-6 col-md-4 col-lg-4">
                                        <div onclick="window,location.href = '/attendancelist/{{ today_attendance_list.id }}'"
                                             class="attendance_list bg-primary-light card-block p-3 rounded-lg h-100"
                                             style="cursor: pointer">
                                            <div class="font-weight-600">Lekcja:</div>
                                            {{ today_attendance_list.lesson_date }}
            
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <h6 class="my-3">Pozostałe listy:</h6>
                        <div class="container ml-0">
                            <div class="row">
                                {% if attendance_lists %}
                                    {% for list in attendance_lists %}
                                        <div class="col-12 col-sm-6 col-md-4 col-lg-4 mb-4">
                                            <div onclick="window.location.href = '/attendancelist/{{ list.id }}'"
                                                 class="attendance_list bg-primary-light card-block p-3 rounded-lg h-100"
                                                 style="cursor: pointer;">
                                                <div class="font-weight-bold">Lekcja:</div>
                                                <div>{{ list.lesson_date }}</div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="bg-light-light card-block p-3 rounded-lg col-12 col-sm-6 col-md-4 col-lg-4 mb-4">
                                            Brak pozostałych list
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>


                </div>

                {% include 'modules/notes.html' %}
            </div>
        </div>
    </div>
    <div class="modal fade" id="attendanceListCreateModalCenter" tabindex="-1" role="dialog"
         aria-labelledby="attendanceListCreateModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="attendanceListModalCenterTitle">Czy chcesz utworzyć Listę Obecności z
                        dzisiejszą datą?</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post" name="attendance_list_form" id="attendance_list_create_form" class="p-2">
                    {% csrf_token %}
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Anuluj</button>
                    <button name="attendance_list_create" id="attendance_list_create" type="submit"
                            class="btn btn-primary">Utwórz Liste Obecności
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editEventModalCenter" tabindex="-1" role="dialog"
         aria-labelledby="cancelModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelModalCenterTitle">Edytowanie lekcji: <span
                            id="editEvent_title"></span></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post" name="cancel_form" id="cancel_plan_form">
                    {% csrf_token %}
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class=" row align-items-center">
                            <div class="form-group col-sm-6">
                                <label for="starTime_cancelForm">Godzina Rozpoczęcia <span class="text-danger">*</span></label>
                                <input name="startTime" type="time" class="form-control" id="starTime_cancelForm"
                                       value="" style="line-height: 20px;"
                                       required>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="lessonDuration_cancelForm">Czas trwania <span class="text-danger">*</span>
                                </label>
                                <select name="lessonDuration" class="form-control "
                                        id="lessonDuration_cancelForm" required>
                                    <option disabled>-</option>
                                    <option value="30">30 min</option>
                                    <option value="45">45 min</option>
                                    <option value="60">60 min</option>
                                </select>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="lessonDate_cancelForm">Data Lekcji <span
                                        class="text-danger">*</span></label>
                                <input name="lessonDate" type="date" class="form-control" id="lessonDate_cancelForm"
                                       value=""
                                       style="line-height: 20px;" required>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="status_cancelForm">Status <span class="text-danger">*</span></label>
                                <select name="status" class="form-control" id="status_cancelForm" required>
                                    <option>Zaplanowana</option>
                                    <option value="Nieobecnosc">Nieobecność</option>
                                    <option value="Odwolana - nauczyciel">Odwołana</option>
                                </select>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="groupForm_cancelForm">Grupa<span class="text-danger">*</span></label>
                                <input class="form-control" id="groupForm_cancelForm" required readonly="">
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="teacher_createLesson">Nauczyciel <span class="text-danger">*</span></label>
                                <select class="form-control" id="teacher_createLesson" name="teacher" required>
                                    {% for user in users %}
                                        <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group col-sm-6" hidden="">
                                <label for="originalDate_cancelForm">original_date</label>
                                <input name="originalDate" type="date" class="form-control" id="originalDate_cancelForm"
                                       value=""
                                       style="line-height: 20px;" readonly="">
                            </div>
                            <div class="form-group col-sm-6" hidden="">
                                <label for="lessonSchedule_cancelForm">lessonSchedule</label>
                                <input name="lessonId" type="text" class="form-control"
                                       id="lessonId_cancelForm"
                                       value=""
                                       style="line-height: 20px;" readonly="">
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="location_createLesson">Lokalizacja <span
                                        class="text-danger">*</span></label>
                                <select class="form-control" id="location_createLesson" name="location" required>
                                    {% for location in locations %}
                                        <option value="{{ location.id }}">{{ location.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group col-sm-6 d-none" id="lessonDate_endSeries_div">
                                <label for="lessonDate_endSeries">Koniec Serii</label>
                                <input name="end_series" type="date" class="form-control" id="lessonDate_endSeries"
                                       value=""
                                       style="line-height: 20px;" data-toggle="tooltip" data-placement="right"
                                       title="Podaj datę ostatniej lekcji z serii. Może być puste">
                            </div>
                            {#                            <div class="form-group col-sm-6">#}
                            {#                                <label for="status_cancelForm">lessonSchedule</label>#}
                            {#                                <input name="status" type="text" class="form-control" id="status_cancelForm"#}
                            {#                                       value=""#}
                            {#                                       style="line-height: 20px;" readonly="">#}
                            {#                            </div>#}
                            <div class="form-group col-sm-6" hidden="">
                                <label for="status_cancelForm">isAdjustment</label>
                                <input name="isAdjustment" type="checkbox" class="form-control"
                                       id="isAdjustment_cancelForm"
                                       style="line-height: 20px;" readonly="">
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
                        <button name="edit_form_submit" id="cancel_form_btn_edit" type="submit"
                                class="btn btn-primary">Zapisz Zmiany
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="createEventModalCenter" tabindex="-1" role="dialog"
         aria-labelledby="createEventModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createEventModalCenterTitle">Dodawanie nowej lekcji</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form method="post" name="create_form" id="create_lesson_form">
                    {% csrf_token %}
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class=" row align-items-center">
                            <div class="form-group col-sm-6">
                                <label for="starTime_createLesson">Godzina Rozpoczęcia <span
                                        class="text-danger">*</span></label>
                                <input name="startTime" type="time" class="form-control" id="starTime_createLesson"
                                       value="" style="line-height: 20px;"
                                       required>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="lessonDuration_createLesson">Czas trwania <span class="text-danger">*</span>
                                </label>
                                <select name="lessonDuration" class="form-control "
                                        id="lessonDuration_createLesson" required>
                                    <option value="30">30 min</option>
                                    <option value="45">45 min</option>
                                    <option value="60">60 min</option>
                                </select>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="lessonDate_createLesson">Data Lekcji <span
                                        class="text-danger">*</span></label>
                                <input name="lessonDate" type="date" class="form-control" id="lessonDate_createLesson"
                                       value=""
                                       style="line-height: 20px;" required>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="repeating_createLesson">Powtarzanie <span
                                        class="text-danger">*</span></label>
                                <select class="form-control" id="repeating_createLesson" name="repeat" required>
                                    <option value="never" selected>Nigdy</option>
                                    <option value="weekly">Co tydzień</option>
                                </select>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="repeating_createLesson">Opis <span class="text-danger">*</span></label>
                                <input name="description" type="text" class="form-control" id="description_createLesson"
                                       value=""
                                       style="line-height: 20px;" required>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="groupForm_cancelForm">Grupa <span class="text-danger">*</span></label>
                                <input class="form-control" id="groupForm_cancelForm"
                                       value="{{ record.get_full_name }}" required readonly="">
                            </div>

                            <div class="form-group col-sm-6">
                                <label for="teacher_createLesson">Nauczyciel <span class="text-danger">*</span></label>
                                <select class="form-control" id="teacher_createLesson" name="teacher" required>
                                    {% for user in users %}
                                        <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group col-sm-6">
                                <label for="location_createLesson">Lokalizacja <span
                                        class="text-danger">*</span></label>
                                <select class="form-control" id="location_createLesson" name="location" required>
                                    {% for location in locations %}
                                        <option value="{{ location.id }}">{{ location.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group col-sm-6 d-none" id="lessonDate_endSeries_div">
                                <label for="lessonDate_endSeries">Koniec Serii</label>
                                <input name="end_series" type="date" class="form-control" id="lessonDate_endSeries"
                                       value=""
                                       style="line-height: 20px;" data-toggle="tooltip" data-placement="right"
                                       title="Podaj datę ostatniej lekcji z serii. Może być puste">
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
                        <button name="create_lesson_form_submit" id="createLesson_form_btn" type="submit"
                                class="btn btn-primary">
                            Utwórz lekcje
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock content %}

{% block javascript %}
    <script src="{% static '/js/watchRecord.js' %}"></script>
    <script src="{% static '/js/lessons.js' %}"></script>
    <script>

        function modifyTable() {
            // Pobranie tabeli
            var table = document.getElementById("lesson_table");

            if (!table) {
                console.error("Tabela nie została znaleziona!");
                return;
            }

            var columnsToRemove = [4, 3]; // Indeksy kolumn: 4 = 'Nieobecne', 3 = 'Odwolane - 24h przed'

            var header = table.querySelector("thead tr");
            columnsToRemove.forEach(function (colIndex) {
                if (header.children[colIndex]) {
                    header.removeChild(header.children[colIndex]);
                }
            });

            var rows = table.querySelectorAll("tbody tr");
            rows.forEach(function (row) {
                columnsToRemove.forEach(function (colIndex) {
                    if (row.children[colIndex]) {
                        row.removeChild(row.children[colIndex]);
                    }
                });
            });

            if (header.children[2]) {
                header.children[2].textContent = "Odwołane";
            }
        }


        let selected_year_div = document.getElementById("selected-year");
        let nextYearBTn = document.getElementById("nextYearBTn");
        let prevYearBtn = document.getElementById("prevYearBtn");


        const delay = (delayInms) => {
            return new Promise(resolve => setTimeout(resolve, delayInms));
        };

        function calculateTimeDifference(startTime, endTime) {
            // Parsowanie godzin na obiekty Date
            const start = new Date(`1970-01-01T${startTime}:00`);
            const end = new Date(`1970-01-01T${endTime}:00`);

            // Obliczenie r\u00F3\u017Cnicy w milisekundach
            const differenceInMilliseconds = end - start;

            // Konwersja milisekund na minuty
            return differenceInMilliseconds / (1000 * 60);
        }

        function modifyEvent(lesson_schedule_id, startTime, endTime, lessonDate, studentName, status, isAdjustment, is_edit = false) {
            let editEvent_title = document.getElementById('editEvent_title');
            let startTime_form = document.getElementById('starTime_cancelForm');
            let lessonDuration_form = document.getElementById('lessonDuration_cancelForm');
            let lessonDate_form = document.getElementById('lessonDate_cancelForm');
            let originalDate_form = document.getElementById('originalDate_cancelForm');
            let lessonId_form = document.getElementById('lessonId_cancelForm');
            let group_form = document.getElementById('groupForm_cancelForm');
            let status_form = document.getElementById('status_cancelForm');
            let btn_plan = document.getElementById('cancel_form_btn_plan');
            let btn_cancel = document.getElementById('cancel_form_btn_cancel');
            let btn_edit = document.getElementById('cancel_form_btn_edit');
            let cancelModalCenterTitle = document.getElementById('cancelModalCenterTitle');
            let isAdjustment_form = document.getElementById('isAdjustment_cancelForm');
            const cancel_title = 'Chcesz odwo\u0142a\u0107 t\u0119 lekcj\u0119?';
            const plan_title = 'Chcesz zaplanowa\u0107 t\u0119 lekcj\u0119?';
            const edit_title = 'Czy chcesz zedytowa\u0107 t\u0119 lekcje?';

            let parts = lessonDate.split('-');
            let day = parts[0];
            let month = parts[1];
            let year = parts[2];

            // Utw\u00F3rz obiekt Date z rozdzielonej daty
            let dateObject = new Date(year, month - 1, day + 1);

            // Uzyskaj warto\u015B\u0107 w formacie rok-miesi\u0105c-dzie\u0144
            let formattedDate = dateObject.toISOString().slice(0, 10);
            const start = new Date(`1970-01-01T${startTime}:00`);
            const end = new Date(`1970-01-01T${endTime}:00`);

            editEvent_title.innerHTML = year + '-' + month + '-' + day;
            startTime_form.value = startTime;
            lessonDuration_form.value = calculateTimeDifference(startTime, endTime);
            lessonDate_form.value = year + '-' + month + '-' + day;
            lessonId_form.value = lesson_schedule_id;
            group_form.value = '{{record.get_full_name}}';
            originalDate_form.value = year + '-' + month + '-' + day;
            status_form.value = status;
            isAdjustment_form.checked = isAdjustment;
        }

        {#let openedMonths = [];#}

        let lessonsLoaded = false;

        function generate_lessons() {
            if (!lessonsLoaded) {
                get_lessons('{{ record.id }}');
                lessonsLoaded = true;
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            let urlParams = new URLSearchParams(window.location.search);

            let selected_year = urlParams.get('selected_year');
            if (!selected_year) {
                const current_year = new Date().getFullYear();
                selected_year = current_year;
                addParamToURL('selected_year', current_year)
            }
            selected_year_div.innerHTML = selected_year


            const tab = urlParams.get('tab');
            if (tab !== undefined) {
                if (tab === 'Lessons' && !lessonsLoaded) {
                    generate_lessons();
                }
            }
            {#openedMonths = urlParams.get('opened_months');#}
            {#if (openedMonths) {#}
            {#    console.log('listener openedMonths ' + openedMonths)#}
            {#    openedMonths = openedMonths.split(',');#}
            {#    openedMonths.forEach(function (monthNumber) {#}
            {#        let collapsibleDiv = document.getElementById('collaps_' + monthNumber);#}
            {#        console.log('listener collapsibleDiv ' + collapsibleDiv)#}
            {#        if (collapsibleDiv) {#}
            {#            collapsibleDiv.classList.add('show');#}
            {#        }#}
            {#    });#}
            {# else#}
            {#    openedMonths = [];#}
            {##}
            {##}
            {#        }#}
            {#    )#}
            {#        ;#}
        })

        function setQueryYear(value) {
            selected_year_div.innerHTML = parseInt(selected_year_div.innerHTML) + value;
            const currentURL = window.location.href;
            let urlSearchParams = new URLSearchParams(window.location.search);
            urlSearchParams.set('selected_year', selected_year_div.innerHTML);
            urlSearchParams.set('opened_months', '');
            window.history.pushState({}, document.title, '?' + urlSearchParams.toString());
            get_lessons('{{ record.id }}');

            {#window.location.href = currentURL.split('?')[0] + '?' + urlSearchParams.toString();#}
        }

        function setQueryYearNow() {
            selected_year_div.innerHTML = new Date().getFullYear();

            const currentURL = window.location.href;
            let urlSearchParams = new URLSearchParams(window.location.search);
            urlSearchParams.set('selected_year', selected_year_div.innerHTML);
            window.history.pushState({}, document.title, '?' + urlSearchParams.toString());
            get_lessons('{{ record.id }}');

            {#window.location.href = currentURL.split('?')[0] + '?' + urlSearchParams.toString();#}
        }

        {#selected_year_div.addEventListener("change", function () {#}
        {#   console.log('year changed');#}
        {#   get_lessons('{{ record.id }}');#}
        {# });#}

        async function refreshOpenedMonths() {
            let delayres = await delay(1000);
            let divElements = document.querySelectorAll('[id^="collaps_"]');
            console.log('refreshing months')
            openedMonths = [];
            divElements.forEach(function (div) {
                let monthNumber = div.id.split('_')[1];
                if (div.classList.contains('show')) {
                    openedMonths.push(monthNumber);
                    console.log('checking ' + monthNumber);
                }
            });

            let urlParams = new URLSearchParams(window.location.search);
            urlParams.set('opened_months', openedMonths.join(','));
            window.history.replaceState({}, '', window.location.pathname + '?' + urlParams.toString());
        }

        function toggleDetails(element) {
            let detailsRow = element.parentElement.nextElementSibling;
            if (detailsRow.classList.contains('details')) {
                if (detailsRow.style.maxHeight === 0) {
                    {#detailsRow.style.display = 'table-row';#}
                    detailsRow.style.maxHeight = 1000 + 'px';
                } else {
                    detailsRow.style.maxHeight = '0px';

                }
            }
        }

        repeating_createLesson = document.getElementById('repeating_createLesson');
        endSeries_input = document.getElementById('lessonDate_endSeries');
        endSeries_div = document.getElementById('lessonDate_endSeries_div');

        repeating_createLesson.addEventListener("change", function () {
            if (repeating_createLesson.value === 'never') {
                endSeries_div.classList.add('d-none');
                endSeries_input.value = null;
            } else {
                endSeries_div.classList.remove('d-none');
            }

        });
    </script>
{% endblock javascript %}