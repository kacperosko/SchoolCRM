{% extends 'base/base.html' %} {# dziedziczenie głównego szablonu #}
{% load static %}
{% block title %}{{ record.get_full_name }}{% endblock title %}
{% block style %}
    <style>
    </style>
{% endblock style %}

{% block content %}
    {% load crm_tags %}

    <div class="card">

        <div class="card-header d-flex justify-content-between">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/student"><i
                            class="ri-home-4-line mr-1 float-left"></i>Uczniowie</a></li>
                    <li class="breadcrumb-item active"
                        aria-current="page">{{ record.get_full_name }}</li>
                </ol>
            </nav>
            <div>
                <button id="watch-button" class="btn rounded-pill" data-trigger="hover" data-toggle="popover"
                        data-content="{% if watch_record %}Obserwujesz ten rekord{% else %}Chcesz obserwować ten rekord?{% endif %}"
                        data-placement="bottom"
                        onclick="watchRecord('{{ record.id }}')"
                        watching-record="{% if watch_record %}following{% else %}notFollowing{% endif %}">
                    <svg id="watch_icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke-width="{% if watch_record %}2.5{% else %}1.5{% endif %}"
                         stroke="currentColor" class="w-6 h-6 {% if watch_record %}text-primary{% endif %}" width="25">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path>
                    </svg>
                </button>
                {% if perms.crm.change_student %}
                    <a href="/student/edit/{{ record.id }}"
                       class="btn btn-primary rounded-pill font-size-12 align-content-center d-inline-flex">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1"
                             stroke="currentColor" class="w-6 h-6 mr-1" width="18">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                        Edytuj
                    </a>
                {% endif %}
                {% if perms.crm.delete_student %}
                    <a href="/delete/{{ record.id }}"
                       class="btn btn-outline-danger rounded-pill font-size-12 d-inline-flex align-content-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                             stroke="currentColor" class="w-6 h-6 mr-1" width="18">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"></path>
                        </svg>
                        Usuń
                    </a>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="myTab-1" role="tablist">
                <li class="nav-item">
                    <a class="nav-link {% if request.GET.tab == 'Details' %}active{% endif %}" id="home-tab"
                       data-toggle="tab" href="#details" role="tab"
                       aria-controls="details" aria-selected="true"
                       onclick="addParamToURL('tab', 'Details')">Szczegóły</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.GET.tab == 'Lessons' %}active{% endif %}" id="lessons-tab"
                       data-toggle="tab" href="#lessons" role="tab"
                       aria-controls="lessons" aria-selected="false"
                       onclick="addParamToURL('tab', 'Lessons'), generate_lessons()">Lekcje</a>
                </li>
                {% if perms.crm.view_invoice %}
                    <li class="nav-item">
                        <a class="nav-link {% if request.GET.tab == 'Invoices' %}active{% endif %}" id="invoices-tab"
                           data-toggle="tab" href="#invoices" role="tab"
                           aria-controls="invoices" aria-selected="false"
                           onclick="addParamToURL('tab', 'Invoices'), generate_lessons()">Faktury</a>
                    </li>
                {% endif %}
                <li class="nav-item">
                    <a class="nav-link {% if request.GET.tab == 'Notes' %}active{% endif %}" id="lessons-tab"
                       data-toggle="tab" href="#notes" role="tab"
                       aria-controls="lessons" aria-selected="false"
                       onclick="addParamToURL('tab', 'Notes')">Notatki</a>
                </li>
            </ul>
            <div class="tab-content" id="tab-student">
                {#      ============ STUDENT TAB ============      #}
                <div class="tab-pane fade {% if request.GET.tab == 'Details' %}show active{% endif %}" id="details"
                     role="tabpanel" aria-labelledby="details-tab">
                    <div class=" row align-items-center">
                        <div class="form-group col-sm-6">
                            <label for="student_first_name" class="text-muted">Imię:</label>
                            <p class="pb-1 field">{{ record.first_name }}</p>
                        </div>
                        <div class="form-group col-sm-6">
                            <label for="student_last_name" class="text-muted">Nazwisko:</label>
                            <p class="py-1 field">{{ record.last_name }}</p>
                        </div>
                        <div class="form-group col-sm-6">
                            <a {% if record.email %}href="mailto:{{ record.email }}"{% endif %}>
                                <label for="student_email" class="text-muted">Email:</label>
                                <p class="pb-1 field">{{ record.email|default:"-" }}</p>
                            </a>
                        </div>
                        <div class="form-group col-sm-6">
                            <label for="student_phone" class="text-muted">Telefon:</label>
                            <p class="pb-1 field">{{ record.phone|phone_format|default:"-" }}</p>
                        </div>
                        <div class="form-group col-sm-6">
                            <label for="" class="text-muted">Data Urodzenia:</label>
                            <p class="pb-1 field">{{ record.birthdate|default:"-" }}</p>
                        </div>
                        <div class="form-group col-sm-6">
                            <label for="" class="text-muted">Wiek:</label>
                            <p class="pb-1 field">{{ record.get_age|default:"-" }}</p>

                        </div>
                        <div class="form-group col-sm-6">
                            <label for="" class="text-muted">Utworzono:</label>
                            <p class="pb-1 field">{{ record.created_date|default:"-" }}
                                {% if record.created_by %}
                                    <a href="/user/view/{{ record.created_by.id }}">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"
                                             class="ml-1" width="18px">
                                            <path d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                                                  stroke-linecap="round" stroke-linejoin="round"></path>
                                        </svg>
                                        <span class="my-auto">{{ record.created_by.get_full_name|default:"-" }}</span>
                                    </a>
                                {% else %}
                                    <span class="my-auto">Użytkownik usunięty</span>
                                {% endif %}
                            </p>

                        </div>
                        <div class="form-group col-sm-6">
                            <label for="" class="text-muted">Ostatnio zmodyfikowano:</label>
                            <p class="pb-1 field">{{ record.modified_date|default:"-" }}
                                {% if record.modified_by %}
                                    <a href="/user/view/{{ record.modified_by.id }}">
                                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"
                                             class="ml-1" width="18px">
                                            <path d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                                                  stroke-linecap="round" stroke-linejoin="round"></path>
                                        </svg>
                                        <span class="my-auto">{{ record.modified_by.get_full_name|default:"-" }}</span>
                                    </a>
                                {% else %}
                                    <span class="my-auto">Użytkownik usunięty</span>
                                {% endif %}
                            </p>

                        </div>
                    </div>
                    <div class="mb-5"></div>
                    <!-- Powiązane kontakty -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Powiązane kontakty</h5>
                            {% if perms.crm.add_student_person %}
                                <a href="/student/{{ record.id }}/student-person/add"
                                   class="btn btn-sm btn-primary rounded-pill d-flex align-items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                         stroke-width="1.5" stroke="currentColor" class="me-1" width="18">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                              d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0
                          3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75
                          0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 1-4.512-.645-6.374-1.766Z"></path>
                                    </svg>
                                    Dodaj kontakt
                                </a>
                            {% endif %}
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-striped table-bordered mb-0">
                                    <thead class="table-light text-center">
                                    <tr>
                                        <th>Imię i nazwisko</th>
                                        <th>Relacja</th>
                                        <th>Email</th>
                                        <th>Telefon</th>
                                        <th>Akcje</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% if student_persons %}
                                        {% for student_person in student_persons %}
                                            <tr>
                                                <td class="text-center">
                                                    <a href="/person/{{ student_person.person.id }}">
                                                        {{ student_person.person.get_full_name }}
                                                    </a>
                                                </td>
                                                <td class="text-center">{{ student_person.relationship_type }}</td>
                                                <td class="text-center">{{ student_person.person.email|default:"-" }}</td>
                                                <td class="text-center">{{ student_person.person.phone|phone_format|default:"-" }}</td>
                                                <td class="text-center">
                                                    <a href="/studentPerson/edit/{{ student_person.id }}"
                                                       class="text-primary me-2" data-bs-toggle="tooltip"
                                                       title="Edytuj relację">
                                                        <!-- Heroicon edit -->
                                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                                                             viewBox="0 0 24 24"
                                                             stroke-width="1" stroke="currentColor" class="w-6 h-6"
                                                             width="18">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                  d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5
                                                  21.036H3v-3.572L16.732 3.732z"></path>
                                                        </svg>
                                                    </a>
                                                    <a href="/delete/{{ student_person.id }}" class="text-danger"
                                                       data-bs-toggle="tooltip" title="Usuń relację">
                                                        <!-- Heroicon trash -->
                                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                                                             viewBox="0 0 24 24"
                                                             stroke-width="1.5" stroke="currentColor" class="w-6 h-6"
                                                             width="18">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                  d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107
                                                  1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0
                                                  1-2.244 2.077H8.084a2.25 2.25 0 0
                                                  1-2.244-2.077L4.772 5.79m14.456
                                                  0a48.108 48.108 0 0 0-3.478-.397m-12
                                                  .562c.34-.059.68-.114 1.022-.165m0
                                                  0a48.11 48.11 0 0 1 3.478-.397m7.5
                                                  0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964
                                                  51.964 0 0 0-3.32 0c-1.18.037-2.09
                                                  1.022-2.09 2.201v.916m7.5 0a48.667
                                                  48.667 0 0 0-7.5 0"></path>
                                                        </svg>
                                                    </a>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center">Brak powiązanych kontaktów</td>
                                        </tr>
                                    {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Historia rekordu -->
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">Historia rekordu</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-striped table-bordered mb-0">
                                    <thead class="table-light text-center">
                                    <tr>
                                        <th>Pole</th>
                                        <th>Stara wartość</th>
                                        <th>Nowa wartość</th>
                                        <th>Zmienione przez</th>
                                        <th>Data</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% if field_history %}
                                        {% for field_h in field_history %}
                                            <tr>
                                                <td class="text-center">{{ field_h.field_name }}</td>
                                                <td class="text-center">{{ field_h.old_value }}</td>
                                                <td class="text-center">{{ field_h.new_value }}</td>
                                                <td class="text-center">{{ field_h.changed_by }}</td>
                                                <td class="text-center">{{ field_h.changed_at }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center">Brak historii</td>
                                        </tr>
                                    {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>


                </div>

                {#      ============ LESSON TAB ============      #}
                {% include 'modules/lessons.html' %}

                {#      ============ INVOICE TAB ============      #}
                {% if perms.crm.view_invoice %}
                    <div class="tab-pane fade {% if request.GET.tab == 'Invoices' %}show active{% endif %}"
                         id="invoices"
                         role="tabpanel" aria-labelledby="lessons-tab">
                        <div class="">
                            <div class="d-flex justify-content-end text-white w-100 mb-3">
                                <a href="/invoice/new?student={{ record.id }}&discard_url=%2Fstudent%2F{{ record.id }}%3Ftab%3DInvoices"
                                   class="btn btn-primary rounded-pill font-size-12 align-content-center d-inline-flex">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                         stroke-width="1"
                                         stroke="currentColor" class="w-6 h-6 mr-1" width="18">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                              d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"></path>
                                    </svg>
                                    Dodaj Fakturę
                                </a>
                            </div>

                            <table class="table table-bordered table-striped" id="generatedTable">
                                <thead>
                                <tr>
                                    <th scope="col" class="text-center">Nr Faktury</th>
                                    <th scope="col" class="text-center">Kwota</th>
                                    <th scope="col" class="text-center">Miesiąc</th>
                                    <th scope="col" class="text-center">Rok</th>
                                    <th scope="col" class="text-center">Czy wysłana?</th>
                                    <th scope="col" class="text-center">Czy zapłacona?</th>
                                    <th scope="col" class="text-center"></th>
                                </tr>
                                </thead>
                                <tbody>
                                {% if not invoices %}
                                    <tr>
                                        <td colspan="7" class="text-center py-3 bg-light-light">
                                            Brak faktur dla tego studenta
                                        </td>
                                    </tr>
                                {% endif %}
                                {% for invoice in invoices %}
                                    <tr>
                                        <th scope="row" class="text-center">
                                            <a type="button" href="/invoice/{{ invoice.id }}"
                                               class="">{{ invoice.name }}
                                            </a>
                                        </th>
                                        <td class="text-center">{{ invoice.get_total_amount|floatformat:"2g" }} zł</td>
                                        <td class="text-center">{{ invoice.invoice_date.month|get_month_name }}</td>
                                        <td class="text-center">{{ invoice.invoice_date.year }}</td>
                                        <td class="text-center">{{ invoice.is_sent|yes_no }}</td>
                                        <td class="text-center">{{ invoice.is_paid|yes_no }}</td>
                                        <td class="text-center">
                                            <a class="text-primary mr-2"
                                               href="/invoice/edit/{{ invoice.id }}"
                                               data-trigger="hover" data-toggle="popover"
                                               data-content="Edytuj fakturę" data-placement="bottom">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                     stroke-width="1"
                                                     stroke="currentColor" class="w-6 h-6 mr-1" width="18">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                          stroke-width="2"
                                                          d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                                </svg>
                                            </a>
                                            <a class="text-warning"
                                               href="/delete/{{ invoice.id }}"
                                               data-trigger="hover" data-toggle="popover"
                                               data-content="Usuń fakturę" data-placement="bottom">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                     stroke-width="1.5"
                                                     stroke="currentColor" class="w-6 h-6 mr-1" width="18">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                          d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"></path>
                                                </svg>
                                            </a>
                                        </td>

                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}

                {#      ============ NOTES TAB ============      #}
                {% include 'modules/notes.html' %}
            </div>
        </div>
    </div>


{% endblock content %}

{% block javascript %}
    <script>
        const recordId = '{{ record.id }}';
    </script>
    <script src="{% static '/js/watchRecord.js' %}"></script>
    <script src="{% static '/js/lessons.js' %}"></script>
{% endblock javascript %}