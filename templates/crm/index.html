{% extends 'base/base.html' %}
{% load crm_tags %}
{% block title %}Home{% endblock title %}
{% block content %}
    <div class="col-md-12 mb-4 mt-1">
        <div class="d-flex flex-wrap justify-content-between align-items-center">
            <h4 class="font-weight-bold">Cześć {{ request.user.first_name }}!</h4>
        </div>
    </div>
    <div class="col-12">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <div class="header-title">
                            <h4 class="card-title">Twoje Dzisiejsze Lekcje</h4>
                        </div>
                        <h6 class="mb-0 text-uppercase d-flex align-items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="pr-2" width="30"
                                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            {{ today_day.date }}
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-spacing mb-0">
                                <tbody>
                                {% if not today_lessons %}
                                    <tr>
                                        <td class="text-center">
                                            <h6 class="mb-0 text-uppercase text-secondary">Brak lekcji na dzisiaj</h6>
                                        </td>
                                    </tr>
                                {% endif %}
                                {% for lesson in today_lessons %}
                                    <tr class="white-space-no-wrap">
                                        <td>
                                            <h6 class="mb-0 text-uppercase text-secondary d-flex align-items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="pr-2" width="30"
                                                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                          stroke-width="2"
                                                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                                {{ lesson.start_time }} - {{ lesson.end_time }}
                                            </h6>
                                        </td>
                                        <td class="pl-0 py-3 align-items-center">
                                            {% if lesson.lesson_definition.student %}
                                                <a type="button"
                                                   href="/student/{{ lesson.lesson_definition.student_id }}"
                                                   class="d-flex align-items-center">
                                                    <svg width="20" class="svg-icon mr-1"
                                                         xmlns="http://www.w3.org/2000/svg"
                                                         fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                              d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5"></path>
                                                    </svg>
                                                    {{ lesson.lesson_definition.student }}
                                                </a>
                                            {% else %}
                                                <a type="button" href="/group/{{ lesson.lesson_definition.group_id }}"
                                                   class="d-flex align-items-center">
                                                    <svg width="20" class="svg-icon mr-1"
                                                         xmlns="http://www.w3.org/2000/svg"
                                                         fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                              d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 0 1-.825-.242m9.345-8.334a2.126 2.126 0 0 0-.476-.095 48.64 48.64 0 0 0-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0 0 11.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"></path>

                                                    </svg>
                                                    {{ lesson.lesson_definition.group }}
                                                </a>
                                            {% endif %}
                                        </td>
                                        <td class="pl-0 py-3">
                                            <h6 class="mb-0 text-secondary  d-flex align-items-center">
                                                <svg width="20px" class="svg-icon mr-1"
                                                     xmlns="http://www.w3.org/2000/svg"
                                                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                          d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                          d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"></path>
                                                </svg>
                                                {{ lesson.location }}
                                            </h6>
                                        </td>
                                        <td class="pl-0 py-3" data-lesson-id="{{ lesson.id }}"
                                            data-current-status="{{ lesson.status }}">
                                            <h6 class="mb-0 text-secondary d-flex align-items-center"
                                                id="container-{{ lesson.id }}">
                                                {% if lesson.lesson_definition.student %}
                                                    <!-- Wyświetlany status -->
                                                    <div class="status-display">
                                                        <div class="{{ lesson.status|get_status_color }} status-box pl-2 p-1 rounded-lg d-flex align-items-center"
                                                             style="min-width: 10rem">
                                                            {{ lesson.get_status_display }}
                                                            <button type="button" name="editLessonStatus"
                                                                    class="btn {{ lesson.status|get_status_color }} ml-2 p-1"
                                                                    data-lesson-id="{{ lesson.id }}">
                                                                <!-- Ikona edycji -->
                                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                                                                     viewBox="0 0 24 24"
                                                                     stroke-width="1" stroke="currentColor"
                                                                     class="w-6 h-6"
                                                                     width="18">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                          stroke-width="2"
                                                                          d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <!-- Formularz edycji -->
                                                    <div class="status-edit d-none ">
                                                        <div class="bg-secondary p-1 rounded-lg d-flex align-items-center">
                                                            <select name="lessonStatus" class="form-control select-form"
                                                                    required style="width: 10rem">
                                                                <option value="zaplanowana">Zaplanowana</option>
                                                                <option value="nieobecnosc">Nieobecność</option>
                                                                <option value="odwolana_nauczyciel">Odwołana -
                                                                    nauczyciel
                                                                </option>
                                                                <option value="odwolana_24h_przed">Odwołana - 24h przed
                                                                </option>
                                                            </select>
                                                            <button type="button"
                                                                    class="cancel-edit btn bg-secondary ml-2 px-1 py-0">
                                                                x
                                                            </button>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    {% if lesson.attendance_list_event.first %}
                                                        <div class="status-display">
                                                            <a class="bg-primary-light text-primary status-box py-2 px-2 rounded-lg d-flex align-items-center"
                                                               href="/attendancelist/{{ lesson.attendance_list_event.first.id }}">
                                                                Otwórz listę obecności
                                                                <!-- Ikona listy -->
                                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                                                                     viewBox="0 0 24 24"
                                                                     stroke-width="1" stroke="currentColor"
                                                                     class="w-6 h-6 ml-2"
                                                                     width="18">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                          d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12Zm0 3h.008v.008H6.75V15Zm0 3h.008v.008H6.75V18Z"></path>
                                                                </svg>
                                                            </a>
                                                        </div>
                                                    {% else %}
                                                        <div class="status-display">
                                                            <button class="btn font-weight-bold bg-light status-box py-2 px-1 rounded-lg d-flex align-items-center"
                                                                    name="createAttendanceList"
                                                                    data-group-id="{{ lesson.lesson_definition.group_id }}"
                                                                    data-event-id="{{ lesson.id }}">
                                                                Dodaj listę obecności
                                                                <!-- Ikona edycji -->
                                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                                                                     viewBox="0 0 24 24"
                                                                     stroke-width="2" stroke="currentColor"
                                                                     class="w-6 h-6"
                                                                     width="18">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                          d="M12 4.5v15m7.5-7.5h-15"></path>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                            </h6>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>

                        </div>
                        <div class="d-flex justify-content-end align-items-center border-top-table p-3">
                            <button onclick="window.location.href = '/calendar'" class="btn btn-secondary btn-sm">
                                Zobacz cały kalendarz
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if request.user.is_superuser or request.user.groups.first == 'Kierownik' %}
        <div class="col-12">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between">
                            <div class="header-title">
                                <h4 class="card-title">Dochód za ostatnie 6 miesięcy</h4>
                                <div class="mt-3 d-flex align-content-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                         stroke-width="1.5"
                                         stroke="currentColor" class="size-6" width="20px">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                              d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"></path>
                                    </svg>
                                    <p class="my-auto ml-1">Dochód liczony jest z sumy wszystkich faktur za dany miesiąc
                                        ze statusem 'Zapłacona'</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <canvas id="incomeChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% csrf_token %}
{% endblock content %}

{% block javascript %}
    {% if request.user.is_admin %}
        <script>

            document.addEventListener("DOMContentLoaded", function () {
                {#const selectElements = document.querySelectorAll('.select-form');#}
                {#selectElements.forEach(function (selectElement) {#}
                {#    if (selectElement.choicesInstance) {#}
                {#        selectElement.choicesInstance.destroy();#}
                {#    }#}
                {#    selectElement.choicesInstance = new Choices(selectElement, {#}
                {#        shouldSort: false,#}
                {#        removeItemButton: true#}
                {#    });#}

                // Dane, które przekażemy do wykresu
                const incomeData = {{ monthly_income|safe }};

                const labels = incomeData.map(item => item.month);
                const data = incomeData.map(item => item.income);

                const ctx = document.getElementById('incomeChart').getContext('2d');
                const incomeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Dochód (PLN)',
                            data: data,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    // Dodanie "PLN" jako suffix na osi Y
                                    callback: function (value, index, values) {
                                        return value + ' PLN';
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        }
                    }
                });

                function getCSRFToken() {
                    return document.querySelector('[name=csrfmiddlewaretoken]').value;
                }

                function getStatusColor(status) {
                    if (status === 'nieobecnosc') {
                        return 'bg-danger-light text-danger';
                    }
                    if (status === 'zaplanowana') {
                        return 'bg-primary-light text-primary';
                    }
                    if (status === 'odwolana_nauczyciel' || status === 'odwolana_24h_przed') {
                        return 'bg-warning-light text-warning';
                    }
                    return 'bg-secondary text-secondary'; // fallback
                }

                document.querySelectorAll('td[data-lesson-id]').forEach(cell => {
                    const lessonId = cell.dataset.lessonId;
                    const currentStatus = cell.dataset.currentStatus;

                    const createAttListBtn = cell.querySelector('button[name="createAttendanceList"]');
                    console.log(createAttListBtn)
                    {#console.log(cell.innerHTML)#}
                    const container = document.getElementById('container-' + lessonId);

                    if (!createAttListBtn) {
                        const displayDiv = cell.querySelector('.status-display');
                        const editDiv = cell.querySelector('.status-edit');
                        const select = editDiv.querySelector('select[name="lessonStatus"]');
                        const cancelBtn = editDiv.querySelector('.cancel-edit');
                        const editBtn = displayDiv.querySelector('button[name="editLessonStatus"]');

                        let originalStatus = currentStatus;

                        // Ustaw domyślny status w select
                        select.value = originalStatus;

                        // Przycisk edycji
                        editBtn.addEventListener('click', function () {
                            select.value = originalStatus;  // reset na aktualny status
                            displayDiv.classList.add('d-none');
                            editDiv.classList.remove('d-none');
                        });
                        // Przycisk anulowania edycji
                        cancelBtn.addEventListener('click', function () {
                            select.value = originalStatus;
                            editDiv.classList.add('d-none');
                            displayDiv.classList.remove('d-none');
                        });

                        // Zmiana selecta – wysyłka AJAX
                        select.addEventListener('change', function () {
                            const newStatus = this.value;

                            fetch("{% url 'crm_update_status' %}", {
                                method: "POST",
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken(),
                                },
                                body: JSON.stringify({
                                    event_id: lessonId,
                                    new_status: newStatus
                                })
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status) {
                                        // Zaktualizuj stan lokalny
                                        originalStatus = newStatus;
                                        cell.dataset.currentStatus = newStatus;

                                        // Zaktualizuj widoczny div
                                        const colorClass = getStatusColor(newStatus);
                                        const statusBox = displayDiv.querySelector('.status-box');

                                        // Aktualizacja klas
                                        statusBox.className = `status-box ${colorClass} p-1 rounded-lg d-flex align-items-center`;

                                        // Aktualizacja zawartości
                                        statusBox.innerHTML = `
                                        ${data.status_display}
                                        <button type="button" name="editLessonStatus"
                                            class="btn ${colorClass} ml-2 p-1" data-lesson-id="${lessonId}">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                                                viewBox="0 0 24 24" stroke-width="1" stroke="currentColor"
                                                class="w-6 h-6" width="18">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                            </svg>
                                        </button>
                                    `;

                                        // Przełącz widoczność
                                        editDiv.classList.add('d-none');
                                        displayDiv.classList.remove('d-none');

                                        // Przypnij ponownie listener do nowego przycisku
                                        statusBox.querySelector('button[name="editLessonStatus"]').addEventListener('click', function () {
                                            select.value = originalStatus;
                                            displayDiv.classList.add('d-none');
                                            editDiv.classList.remove('d-none');
                                        });

                                        handleResponse(data);  // opcjonalny alert
                                    } else {
                                        alert("Błąd: " + data.error || "Nie udało się zaktualizować statusu.");
                                    }
                                })
                                .catch(error => {
                                    console.error('Błąd:', error);
                                    alert("Błąd połączenia z serwerem.");
                                });
                        });
                    } else {
                        createAttListBtn.addEventListener('click', function () {
                            addInformAlert("Tworzenie listy obecności...");

                            const groupId = createAttListBtn.dataset.groupId;
                            const eventId = createAttListBtn.dataset.eventId;
                            console.log("groupId: " + groupId);
                            console.log("eventId: " + eventId);
                            const formData = new FormData();
                            formData.append("event_id", eventId);
                            formData.append("group_id", groupId);
                            console.log("{% url 'crm_create_attendance_list' %}")
                            fetch("{% url 'crm_create_attendance_list' %}", {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'X-CSRFToken': getCSRFToken(),
                                },
                                body: formData
                            }).then(response => response.json())
                                .then(data => {
                                    if (data.status) {
                                        container.removeChild(container.firstChild);

                                        container.innerHTML = `
                                        <div class="status-display">
                                            <a class="bg-primary-light text-primary status-box py-2 px-2 rounded-lg d-flex align-items-center"
                                               href="/attendancelist/${data.attendance_list_id}">
                                                Otwórz listę obecności
                                                <!-- Ikona listy -->
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                                                     viewBox="0 0 24 24"
                                                     stroke-width="1" stroke="currentColor"
                                                     class="w-6 h-6 ml-2"
                                                     width="18">
                                                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12Zm0 3h.008v.008H6.75V15Zm0 3h.008v.008H6.75V18Z"></path>
                                                </svg>
                                            </a>
                                        </div>
                                    `;
                                    }
                                    handleResponse(data);

                                }).catch(error => {
                                console.error('Error:', error);
                                alert('Wystąpił błąd przy tworzeniu listy obecności.');
                            });
                        })
                    }
                });

            });
        </script>
    {% endif %}
{% endblock javascript %}
