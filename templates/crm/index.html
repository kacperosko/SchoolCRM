{% extends 'base/base.html' %}
{% load crm_tags %}
{% block title %}Home{% endblock title %}
{% block content %}
    <div class="col-md-12 mb-4 mt-1">
        <div class="d-flex flex-wrap justify-content-between align-items-center">
            <h4 class="font-weight-bold">Cześć {{ request.user.first_name }}!</h4>
        </div>
    </div>
    <div class="col-12">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <div class="header-title">
                            <h4 class="card-title">Twoje Dzisiejsze Lekcje</h4>
                        </div>
                        <h6 class="mb-0 text-uppercase d-flex align-items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="pr-2" width="30"
                                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            {{ today_day.date }}
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-spacing mb-0">
                                <tbody>
                                {% if not today_lessons %}
                                    <tr>
                                        <td class="text-center">
                                            <h6 class="mb-0 text-uppercase text-secondary">Brak lekcji na dzisiaj</h6>
                                        </td>
                                    </tr>
                                {% endif %}
                                {% for lesson in today_lessons %}
                                    <tr class="white-space-no-wrap">
                                        <td>
                                            <h6 class="mb-0 text-uppercase text-secondary d-flex align-items-center">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="pr-2" width="30"
                                                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                          stroke-width="2"
                                                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                                {{ lesson.start_time }} - {{ lesson.end_time }}
                                            </h6>
                                        </td>
                                        <td class="pl-0 py-3 align-items-center">
                                            <a type="button" href="/student/{{ lesson.lesson_definition.student_id }}"
                                               class="d-flex align-items-center">
                                                <svg width="20" class="svg-icon mr-1"
                                                     xmlns="http://www.w3.org/2000/svg"
                                                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                          d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5"></path>

                                                </svg>
                                                {{ lesson.lesson_definition.student }}
                                            </a>
                                        </td>
                                        <td class="pl-0 py-3">
                                            <h6 class="mb-0 text-secondary  d-flex align-items-center">
                                                <svg width="20px" class="svg-icon mr-1" xmlns="http://www.w3.org/2000/svg"
                                                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                          d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                          d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"></path>
                                                </svg>
                                                {{ lesson.location }}
                                            </h6>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>

                        </div>
                        <div class="d-flex justify-content-end align-items-center border-top-table p-3">
                            <button onclick="window.location.href = '/calendar'" class="btn btn-secondary btn-sm">Zobacz
                                cały kalendarz
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if request.user.is_admin %}
        <div class="col-12">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between">
                            <div class="header-title">
                                <h4 class="card-title">Dochód za ostatnie 6 miesięcy</h4>
                                <div class="mt-3 d-flex align-content-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                         stroke-width="1.5"
                                         stroke="currentColor" class="size-6" width="20px">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                              d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z"></path>
                                    </svg>
                                    <p class="my-auto ml-1">Dochód liczony jest z sumy wszystkich faktur za dany miesiąc
                                        ze statusem 'Zapłacona'</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <canvas id="incomeChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

{% endblock content %}

{% block javascript %}
    {% if request.user.is_admin %}
        <script>
            // Dane, które przekażemy do wykresu
            const incomeData = {{ monthly_income|safe }};

            const labels = incomeData.map(item => item.month);
            const data = incomeData.map(item => item.income);

            const ctx = document.getElementById('incomeChart').getContext('2d');
            const incomeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Dochód (PLN)',
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                // Dodanie "PLN" jako suffix na osi Y
                                callback: function (value, index, values) {
                                    return value + ' PLN';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    }
                }
            });
        </script>
    {% endif %}
{% endblock javascript %}
